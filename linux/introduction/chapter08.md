# Chapter08 vi/Vim

vi/Vimは，多くのLinuxディストリビューションでデフォルトでインストールされている．
テキストファイルを編集するエディタとして多くのユーザに利用されている．
マウスや矢印キーを使わないという点で非常に独特であるが，使い慣れると非常に高速にファイルを編集できるようになる．
初めて使う場合は戸惑うことが多いので，基本的な使い方を紹介する．
興味があればさらに学習するとよい．
8.1ではviとVimの違いを紹介する．
8.2ではVimのモードとコマンドを紹介する．
8.3ではVimチュートリアルを実際に体験する．

## 8.1 viとVim

現在のLinuxではviが使われていることは少なく，Vimが使われていることがほとんどである．
viは環境非依存で特に設定せずに用いることが多いが，それでは作業効率を高めることができない．
そこで，viに対して様々な機能を付加したVim(vi improved)が使われている．
Vimはカスタマイズ性が非常に高く，ユーザが自身の好みに合わせて徹底的に改良できる．
本資料ではVimを用いて説明する．
多くの部分でviと共通であるが，一部はVimにしかない機能もあるのでviを知りたい場合は注意する．

Vimのバージョン等を確認する．

```bash
which vim    # vimのパスを表示する
vim --version    # vimのバージョンを確認する
```

Vimは下記のコマンドで実行できる．

```bash
vi     # Vimを開く
vi <file>     # ファイルを指定してVimを開く
```

## 8.2 Vimのモードと基本的なコマンド

Vimには特に重要な4つのモードがある．
それ以外も存在するが，まずはこの4つを理解することでVimへの理解が深まる．
Vimはモードごとにキー割当が変化する．
この機能により，キーボードのみですべての編集機能を利用できる．
はじめのうちは現在のモードが分からなくなることが多い．
その場合，ESCキーを2回押すとノーマルモードに戻ることができる．

- ノーマルモード
  - カーソル移動やテキストの削除，コピー，ペーストなどの指示を行う
- ビジュアルモード
  - テキストを選択するモード
- インサートモード
  - 実際にテキストを入力するモード
- コマンドラインモード
  - ファイルを開いたり，検索・置換などの指示を行う

図にするとこのような関係になる．

```mermaid
graph LR
  I[インサートモード] -- ＜ESC＞ --> N[ノーマルモード]
  V[ビジュアルモード] -- ＜ESC＞ --> N
  N -- i, a, o, I, A, O --> I
  N -- v, V --> V
  N -- : --> C[コマンドラインモード]
  C -- ＜ESC＞ --> N
  style N fill:#f9f,stroke:#333,stroke-width:2px
  style I fill:#bbf,stroke:#333,stroke-width:1px
  style V fill:#bfb,stroke:#333,stroke-width:1px
  style C fill:#ffb,stroke:#333,stroke-width:1px
```

図. Vimの基本的なモード遷移図（横一直線＋コマンドラインモードは下）


ここからは各モードでよく使われるものを紹介する．

その前にキー入力の記述方法を示す．

- `x` と書かれた場合，小文字の“x”を表す
- `X` と書かれた場合，大文字の“X”を表す
- `C-x` と書かれた場合，Controlキーを押しながら小文字の“x”を押す
- `xy` と書かれた場合，小文字の“x”を押し，その後小文字の“y”を押す
- `5x` と書かれた場合，数字の“5”を押し，その後小文字の“x”を押す(数字は特に指定がない限り任意)

### ノーマルモード

移動に関わるコマンド

| キー入力 | 意味 |
| --- | --- |
| `h` | 左に移動する |
| `j` | 下に移動する |
| `k` | 上に移動する |
| `l` | 右に移動する |
| `w` | 次の単語の先頭に移動する |
| `b` | 前の単語の先頭に移動する |
| `e` | 次の単語の最後に移動する |
| `C-u` | 上のページに移動する |
| `C-d` | 下のページに移動する |
| `gg` | ファイルの最初の行に移動する |
| `G` | ファイルの最後の行に移動する |
| `0` | 今いる行の先頭に移動する |
| `$` | 今いる行の最後に移動する |
| `C-g` | 今カーソルがある位置を表示する |

移動コマンドは，数字と組み合わせることもでき，
例えば，`5j`とすると，カーソルを下に5行移動することができる．

文字列を入力するためにノーマルモードからインサートモードになるコマンド

| キー入力 | 意味 |
| --- | --- |
| `i` | カーソル位置でインサートモードになる |
| `A` | カーソル位置を行末に移動しインサートモードになる |
| `o` | 新しく下に行を作成しインサートモードになる |
| `O` | 新しく上に行を作成しインサートモードになる |

文字列を編集するためのコマンド

| キー入力 | 意味 |
| --- | --- |
| `x` | 文字を削除する |
| `dd` | 行を削除する |
| `cc` | 行を変更する |
| `u` | 最後のコマンドを取り消す |
| `C-r` | 取り消しを取り消す |
| `rx` | カーソル位置の文字を別の文字(`x`)に置換する |
| `p` | カーソルの後に貼り付ける |
| `/word` | `word`という単語を検索する．Enter後に`n`で前方検索，`N`で後方検索 |
| `s/old/new/g` | `old`をすべて`new`に置換する．`%s`とするとファイル全体で置換 |

削除コマンドは，数字や移動コマンドと組み合わせることもでき，
例えば，`5dd`とすると，カーソル位置から下に5行削除することができる，
また，`d$`とすると，カーソル位置から行末まで削除することができる．

### ビジュアルモード

`v`を押すとビジュアルモードになる．
ビジュアルモード後，移動コマンドで範囲を選択でき，その範囲に対して削除コマンドなどを実行できる．

### インサートモード

インサートモードでは実際に文字を入力できる．
ノーマルモードで`i`や`o`などを押すとインサートモードになる．

### コマンドラインモード

`:`を押すとさまざまなコマンドを使用できる．

| キー入力 | 意味 |
| --- | --- |
| `:w` | ファイルを保存する |
| `:q` | ファイルを閉じる |
| `:r <file>` | カーソル位置の下に`<file>`の中身を読み込む |

### リピート
Vimでは、直前に実行したコマンドを繰り返すことができる．
ノーマルモードにて`.`と入力することで、直前のコマンドを繰り返すことができる．
また，`q<任意の文字>`と入力すると、マクロの記録が開始される．
`q<任意の文字>`を押した後に実行したコマンドは、次に`q`を押すまで記録される．
その後、別の場所で`@<任意の文字>`を押すことで、記録したコマンドを再実行できる．
例えば，
```bash
qa # マクロの記録を開始
10j # 下に10行移動
q # マクロの記録を終了
@a # マクロを実行
```

## 8.3 Vimのチュートリアル

シェル上で下記のコマンドを入力すると，チュートリアルを体験できる．
チュートリアルのテキストファイルをVimで開き，実際にVimを操作できる．
実際にチュートリアルを行うことでVimを実践できる．

```bash
vimtutor
```

## 補足 Vimのカスタマイズ

Vimには大きく2つのカスタマイズ方法がある．
1つ目は`~/.vimrc`ファイルに初期設定を記述する方法である．
2つ目はVim Scriptを使ったプラグインである．
これらの方法によりVimにさまざまな機能を付与し，作業を効率化できる．

また，Vimの派生系としてNeovimがある．
NeovimはVimの機能を拡張したもので，特にプラグインの開発が活発であり，よりモダンなエディタ体験を提供する．
著者もNeovimを使用しており，Vimと同様の操作感でありながら，より多くの機能を利用でき，IDEとしても利用できるため非常に便利である．
そしてなによりも画面がかっこいいのである．
興味があればNeovimも試してみるとよい．