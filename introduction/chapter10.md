# Chapter10 シェルスクリプト

本章ではシェルスクリプトについて簡単に紹介します．シェルスクリプトとは、一連のシェル操作をテキストファイルに記述したものです．シェルスクリプトを用いることで，一連のコマンド入力を自動化することが可能になります．10.1では，シェルスクリプトの作成から実行までの流れを紹介します．10.2ではシェルスクリプトの文法について基本的な部分を説明します．

## 10.1 シェルスクリプトの作成と実行

まずはシェルスクリプトを作成し，実行するまでの流れを紹介します．

1. 拡張子が `.sh` となるファイルを作成します．
2. 1行目には利用するシェルを指定し，2行目以降に実行するコマンドを1行ずつ書きます．
3. シェルスクリプトを記述したファイルに実行権限を付与します．
4. `./<file>.sh` として実行します．

### ファイルの作成

vi等のエディタを使って，拡張子は `.sh` とします．

```bash
vi file.sh    # viを使って file.sh を作成します．
```

### シェルスクリプトの記述

1行目には利用するシェル (シェバンといいます) を記述し，2行目以降に実行するコマンドを記述します．実行コマンドは1行ずつ入力します．

もし1行で書ききれない場合は `\` (バックスラッシュ) を用います．また，シェルスクリプト中にコマンドを使いたい場合， `#` 以後がコマンドになります．

```bash
#!/bin/bash    # ここではbashを用います．
whoami
ls
date
```

### 実行権限の付与

`chmod` を使って実行権限を付与します．

```bash
chmod u+x <file>.sh
```

### シェルスクリプトの実行

`./` をつけてファイルを指定します． `./` はパス指定を意味しており，「カレントディレクトリにある」という意味になります．今まで使ってきた `ls` や `whoami` などはすでにパスが通っているためこのような指定は不要ですが，自分で作成したシェルスクリプトを実行する場合，パス指定が必要になります．

```bash
./<file>.sh
```

## 10.2 シェルスクリプトの文法

ここからはシェルスクリプトの文法を簡単に紹介します．他にもいろいろな文法がありますが，ここでは非常に簡単なものだけを紹介します．

### 変数

変数とは，値を格納するための箱のようなもので，数値や文字列が入ります．数学で用いる x や y をイメージすると分かりやすいです．

(シェル)変数の代入は `=` を使い，変数の中身を参照するには， `$<変数名>` とします．変数の代入時， `=` の前後に空白をあけてはいけません．

```bash
hoge=ABC
echo $hoge    # ABC
```

シェルには2種類の変数があります．？？？

- シェル変数
    - 実行中のシェルの内部のみで有効
    - シェル変数の作成には， `=` を用いて代入するだけです．
    - シェル変数の一覧確認は ，`set` コマンドを用います．
    - シェル変数を削除する場合， `unset` コマンドを用います．
- 環境変数
    - 環境変数はその変数を定義したシェル上とそのシェルで実行されるプログラムで有効です．
    - 環境変数の作成には， `export` を用います．
    - 環境変数の一覧確認は， `env` コマンドを用います．
    - 環境変数を削除する場合， `unset` コマンドを用います．

```bash
c=shell_var
export d=env_var
echo $c
echo $d
bash
echo $c    # 表示されない
echo $d
exit
echo $c
echo $d

```

### 引用符

シェルスクリプトでは，引用符は3種類あります．それぞれ引用符に囲まれた文字列の扱いが変わります．また，引用符は入れ子が可能です．

- `'` (シングルクォート)
    - 参照用の `$` 付き文字列はそれ自体が文字列として扱われるため，変数は展開されません．
- `"` (ダブルクォート)
    - 参照用の `$` 付き文字列は変数が展開された文字列になります．
- ``` (バッククォート)
    - コマンドとして解釈され， `$` 付き変数があれば，それを展開した上でコマンドが実行されます．

```bash
hoge=date
echo '$hoge'    # $hoge
echo "$hoge"    # date
echo `$hoge`    # dateコマンドが実行され，今の日付が表示される
```

### 引数

シェルスクリプトは，実行時にオプションを引数として参照することができます．引数は `$1, $2, ...` のように， `$` の後に引数の番号を指定することで参照することができます．

### エスケープ文字

`\` は特別な文字で，下記のような機能を持ちます．

- シェルスクリプト中で `”` は引用符を意味しますが， `\"` とすることで，ダブルクォートの文字として扱うことができます．
- 行末に `\` を用いることで，改行することができます．
- `\t` とすることでタブ， `\n` とすることで改行を意味することもできます．

### 条件分岐

`if`を用いることで，条件分岐を行うことができます．次の書式になります．

```bash
if <条件式1> then
	処理
elif <条件式2> then 
  処理
else
	処理
fi
```

条件式には文字列の比較や数値比較，ファイル属性の確認などがあります．

文字列の比較

| 演算子 | 比較内容 |
| --- | --- |
| `a == b` | `a` と `b` が等しければ真 |
| `a != b`  | `a` と `b` が等しくなければ真 |

数値の比較

| 演算子 | 比較内容 |
| --- | --- |
| `a -eq b`  | `a=b` ならば真 |
| `a -ne b`  | `a!=b` ならば真 |
| `a -ge b`  | `a>=b` ならば真 |
| `a -le b`  | `a<=b` ならば真 |
| `a -gt b`  | `a>b` ならば真  |
| `a -lt b`  | `a<b` ならば真 |

ファイル属性の確認

| 演算子 | 確認内容 |
| --- | --- |
| `[ -f <file名> ] ;`  | 通常ファイルなら真 |
| `[ -d <file名> ] ;`  | ディレクトリなら真 |
| `[ -e <file名> ] ;`  | ファイルが存在するなら真 |
| `[ -x <file名> ] ;`  | ファイルが存在して，実行権限があれば真 |

なお，ファイル属性の確認には， `[ ]` 以外にも `test` コマンドを用いる方法もあります．

### 繰り返し

`for`文は値を列挙し，それを対象に処理を繰り返します．

```bash
for <変数> in <値のリスト>
do
	処理
done
```

例えば，以下のように記述します

```bash
for al in a b c d e
do
	echo $al
done
```

### 関数

関数は，引数と呼ばれるデータを与え，処理をして結果を返すという機能です．次の書式でかけます．

```bash
function <関数名>
{
	処理
	引数は$1, $2 を用います．
}
```

関数を実行する場合，次の書式で記述します．

```bash
<関数名> <引数1> <引数2>
```

例えば以下のような関数を定義し，実行します．

```bash
function hello
{
		echo "Hello, $1"
}
```

```bash
hello Tom   # Hello, Tom
hello Bob   # Hello, Bob
```